\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Machine Learning Analysis with Lagged Predictors},
            pdfauthor={Falco J. Bargagli-Stoffi, Massimo Riccaboni, Armando Rungi},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\providecommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Machine Learning Analysis with Lagged Predictors}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Falco J. Bargagli-Stoffi, Massimo Riccaboni, Armando Rungi}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{23/2/2020}


\begin{document}
\maketitle

\hypertarget{introduction}{%
\section{Introduction}\label{introduction}}

This \texttt{R Markdown} file reproduces the lagged machine learning
analysis for the paper
\textit{"Machine learning for zombie hunting. Firms' failures, financial constraints, and misallocation"}
by Falco J. Bargagli-Stoffi (IMT School for Advanced Studies/KU Leuven),
Massimo Riccaboni (IMT School for Advanced Studies) and Armando Rungi
(IMT School for Advanced Studies).

\hypertarget{r-markdown}{%
\subsection{R Markdown}\label{r-markdown}}

This is an \texttt{R Markdown} document. Markdown is a simple formatting
syntax for authoring HTML, PDF, and MS Word documents. For more details
on using \texttt{R Markdown} see \url{http://rmarkdown.rstudio.com}.

When you click the \textbf{Knit} button a document will be generated
that includes both content as well as the output of any embedded
\texttt{R} code chunks within the document. You can embed an R code
chunks like the following.

\hypertarget{packages-upload}{%
\subsection{Packages Upload}\label{packages-upload}}

The following packages and functions are the ones used for the analyses
performed in the \texttt{R} code. The \texttt{functions.R} file contains
the functions \texttt{F1\_score}, \texttt{balanced\_accuracy},
\texttt{model\_compare} and \texttt{DtD} that were developed to
reproduce the following analyses.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{rm}\NormalTok{(}\DataTypeTok{list=}\KeywordTok{ls}\NormalTok{()) }\CommentTok{# to clean the memeory}
\KeywordTok{memory.limit}\NormalTok{(}\DataTypeTok{size=}\DecValTok{1000000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## [1] 1e+06
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{options}\NormalTok{(}\DataTypeTok{java.parameters =} \StringTok{"-Xmx15000m"}\NormalTok{)}
\KeywordTok{library}\NormalTok{(rJava)}
\KeywordTok{library}\NormalTok{(bartMachine)}
\KeywordTok{library}\NormalTok{(haven)}
\KeywordTok{library}\NormalTok{(plyr)}
\KeywordTok{library}\NormalTok{(dplyr)}
\KeywordTok{library}\NormalTok{(PRROC)}
\KeywordTok{library}\NormalTok{(rpart)}
\KeywordTok{library}\NormalTok{(party)}
\KeywordTok{library}\NormalTok{(finalfit)}
\KeywordTok{library}\NormalTok{(caret)}
\KeywordTok{library}\NormalTok{(Amelia)}
\KeywordTok{library}\NormalTok{(PresenceAbsence)}
\KeywordTok{library}\NormalTok{(devtools)}
\KeywordTok{library}\NormalTok{(SuperLearner)}
\KeywordTok{library}\NormalTok{(Metrics)}
\KeywordTok{library}\NormalTok{(pROC)}
\KeywordTok{library}\NormalTok{(Hmisc)}
\KeywordTok{library}\NormalTok{(GGally)}
\KeywordTok{library}\NormalTok{(mice)}
\KeywordTok{source}\NormalTok{(}\StringTok{'functions.R'}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{data-upload}{%
\subsection{Data Upload}\label{data-upload}}

In the following chunks of code we upload the data, we initialize the
main variables used in the analysis and we restrict the sample to the
Italian firms.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data <-}\StringTok{ }\KeywordTok{read_dta}\NormalTok{(}\StringTok{"analysis_data_indicators.dta"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{names}\NormalTok{(data)[}\KeywordTok{names}\NormalTok{(data) }\OperatorTok{==}\StringTok{ 'GUO___BvD_ID_number'}\NormalTok{] <-}\StringTok{ 'guo'}
\NormalTok{data}\OperatorTok{$}\NormalTok{control <-}\StringTok{ }\KeywordTok{ifelse}\NormalTok{(data}\OperatorTok{$}\NormalTok{guo}\OperatorTok{==}\StringTok{""}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\NormalTok{data}\OperatorTok{$}\NormalTok{nace <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(data}\OperatorTok{$}\NormalTok{nace)}
\NormalTok{data}\OperatorTok{$}\NormalTok{area <-}\StringTok{ }\KeywordTok{as.factor}\NormalTok{(data}\OperatorTok{$}\NormalTok{area)}
\KeywordTok{levels}\NormalTok{(data}\OperatorTok{$}\NormalTok{nace) <-}\StringTok{ }\KeywordTok{floor}\NormalTok{(}\KeywordTok{as.numeric}\NormalTok{(}\KeywordTok{levels}\NormalTok{(data}\OperatorTok{$}\NormalTok{nace))}\OperatorTok{/}\DecValTok{100}\NormalTok{) }
\NormalTok{data_italy <-}\StringTok{ }\NormalTok{data[}\KeywordTok{which}\NormalTok{(data}\OperatorTok{$}\NormalTok{iso}\OperatorTok{==}\StringTok{"IT"}\NormalTok{),] }
\end{Highlighting}
\end{Shaded}

\hypertarget{machine-learning-analysis}{%
\section{Machine Learning Analysis}\label{machine-learning-analysis}}

\hypertarget{data-inizialization}{%
\subsection{Data Inizialization}\label{data-inizialization}}

Select the lagged variables.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lagged_variables <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"failure"}\NormalTok{, }\StringTok{"iso"}\NormalTok{, }\StringTok{"control"}\NormalTok{, }\StringTok{"nace"}\NormalTok{,}
                      \StringTok{"shareholders_funds"}\NormalTok{, }\StringTok{"added_value"}\NormalTok{,}
                      \StringTok{"cash_flow"}\NormalTok{, }\StringTok{"ebitda"}\NormalTok{, }\StringTok{"fin_rev"}\NormalTok{,}
                      \StringTok{"liquidity_ratio"}\NormalTok{, }\StringTok{"total_assets"}\NormalTok{,}
                      \StringTok{"depr"}\NormalTok{, }\StringTok{"long_term_debt"}\NormalTok{, }\StringTok{"employees"}\NormalTok{,}
                      \StringTok{"materials"}\NormalTok{, }\StringTok{"loans"}\NormalTok{, }\StringTok{"wage_bill"}\NormalTok{,}
                      \StringTok{"tfp_acf"}\NormalTok{, }\StringTok{"fixed_assets"}\NormalTok{, }\StringTok{"tax"}\NormalTok{,}
                      \StringTok{"current_liabilities"}\NormalTok{, }\StringTok{"current_assets"}\NormalTok{,}
                      \StringTok{"fin_expenses"}\NormalTok{, }\StringTok{"int_paid"}\NormalTok{,}
                      \StringTok{"solvency_ratio"}\NormalTok{, }\StringTok{"net_income"}\NormalTok{,}
                      \StringTok{"revenue"}\NormalTok{, }\StringTok{"consdummy"}\NormalTok{, }\StringTok{"capital_intensity"}\NormalTok{,}
                      \StringTok{"fin_cons100"}\NormalTok{, }\StringTok{"inv"}\NormalTok{, }\StringTok{"ICR_failure"}\NormalTok{,}
                      \StringTok{"interest_diff"}\NormalTok{, }\StringTok{"NEG_VA"}\NormalTok{, }\StringTok{"real_SA"}\NormalTok{,}
                      \StringTok{"Z_score"}\NormalTok{, }\StringTok{"misallocated_fixed"}\NormalTok{,}
                      \StringTok{"profitability"}\NormalTok{, }\StringTok{"area"}\NormalTok{, }\StringTok{"dummy_patents"}\NormalTok{,}
                      \StringTok{"dummy_trademark"}\NormalTok{,}\StringTok{"financial_sustainability"}\NormalTok{,}
                      \StringTok{"liquidity_return"}\NormalTok{, }\StringTok{"int_fixed_assets"}\NormalTok{)}
\NormalTok{data_lagged <-}\StringTok{ }\NormalTok{data_italy[lagged_variables]}
\end{Highlighting}
\end{Shaded}

Select the predictors.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{predictors <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"control"}\NormalTok{, }\StringTok{"nace"}\NormalTok{, }\StringTok{"shareholders_funds"}\NormalTok{,}
                \StringTok{"added_value"}\NormalTok{, }\StringTok{"cash_flow"}\NormalTok{, }\StringTok{"ebitda"}\NormalTok{,}
                \StringTok{"fin_rev"}\NormalTok{, }\StringTok{"liquidity_ratio"}\NormalTok{, }\StringTok{"total_assets"}\NormalTok{,}
                \StringTok{"depr"}\NormalTok{, }\StringTok{"long_term_debt"}\NormalTok{, }\StringTok{"employees"}\NormalTok{,}
                \StringTok{"materials"}\NormalTok{, }\StringTok{"loans"}\NormalTok{, }\StringTok{"wage_bill"}\NormalTok{, }\StringTok{"tfp_acf"}\NormalTok{,}
                \StringTok{"fixed_assets"}\NormalTok{, }\StringTok{"tax"}\NormalTok{, }\StringTok{"current_liabilities"}\NormalTok{,}
                \StringTok{"current_assets"}\NormalTok{, }\StringTok{"fin_expenses"}\NormalTok{, }
                \StringTok{"solvency_ratio"}\NormalTok{, }\StringTok{"net_income"}\NormalTok{, }\StringTok{"revenue"}\NormalTok{,}
                \StringTok{"consdummy"}\NormalTok{, }\StringTok{"capital_intensity"}\NormalTok{, }\StringTok{"fin_cons100"}\NormalTok{,}
                \StringTok{"inv"}\NormalTok{, }\StringTok{"ICR_failure"}\NormalTok{, }\StringTok{"interest_diff"}\NormalTok{, }\StringTok{"NEG_VA"}\NormalTok{,}
                \StringTok{"real_SA"}\NormalTok{, }\StringTok{"misallocated_fixed"}\NormalTok{, }\StringTok{"profitability"}\NormalTok{,}
                \StringTok{"area"}\NormalTok{, }\StringTok{"dummy_patents"}\NormalTok{, }\StringTok{"dummy_trademark"}\NormalTok{,}
                \StringTok{"financial_sustainability"}\NormalTok{, }\StringTok{"liquidity_return"}\NormalTok{,}
                \StringTok{"int_fixed_assets"}\NormalTok{)}
\CommentTok{# no int_paid due to multicollinearity issue (no prediction from MICE)}
\NormalTok{formula <-}\StringTok{ }\KeywordTok{as.formula}\NormalTok{(}\KeywordTok{paste}\NormalTok{(}\StringTok{"as.factor(failure) ~"}\NormalTok{,}
                            \KeywordTok{paste}\NormalTok{(predictors, }\DataTypeTok{collapse=}\StringTok{"+"}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

Create training and testing sets by assigning 90\% of the observations
to the training set and 10\% to the testing set. This dataset is of the
same size of the dataset used in the main analysis omitting the missing
observations.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\NormalTok{data_size <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\KeywordTok{seq_len}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(data_lagged)), }\DataTypeTok{size =} \DecValTok{92819}\OperatorTok{*}\FloatTok{0.1}\NormalTok{) }
\NormalTok{omitted <-}\StringTok{ }\NormalTok{data_lagged[data_size,]}
\end{Highlighting}
\end{Shaded}

For the data imputation we use the with multiple imputations using the
CART (Friedman et al., 1984) Fully Conditional Specification (FCS)
developed by (Van Buuren et al., 2010) and implemented in the \texttt{R}
package \texttt{MICE}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{imputed_data <-}\StringTok{ }\KeywordTok{mice}\NormalTok{(omitted, }\DataTypeTok{m =} \DecValTok{1}\NormalTok{, }\DataTypeTok{maxit =} \DecValTok{1}\NormalTok{, }\DataTypeTok{method =} \StringTok{'cart'}\NormalTok{, }\DataTypeTok{seed =} \DecValTok{500}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## 
##  iter imp variable
##   1   1  shareholders_funds  added_value  cash_flow  ebitda  fin_rev  liquidity_ratio  total_assets  depr  long_term_debt  employees  materials  loans  wage_bill  tfp_acf  fixed_assets  tax  current_liabilities  current_assets  fin_expenses  solvency_ratio  net_income  revenue  capital_intensity  fin_cons100  inv  ICR_failure  interest_diff  NEG_VA  real_SA  Z_score  misallocated_fixed  profitability  financial_sustainability  liquidity_return  int_fixed_assets
\end{verbatim}

\begin{verbatim}
## Warning: Number of logged events: 37
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data_imp <-}\StringTok{ }\KeywordTok{complete}\NormalTok{(imputed_data, }\DecValTok{1}\NormalTok{)}
\NormalTok{data_imp <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(omitted}\OperatorTok{$}\NormalTok{failure, data_imp))}
\NormalTok{index <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\KeywordTok{seq_len}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(data_imp)), }\DataTypeTok{size =} \KeywordTok{nrow}\NormalTok{(data_imp)}\OperatorTok{*}\FloatTok{0.9}\NormalTok{) }
\NormalTok{train <-}\StringTok{ }\NormalTok{data_imp[index,]}
\NormalTok{test <-}\StringTok{ }\NormalTok{data_imp[}\OperatorTok{-}\NormalTok{index,]}
\end{Highlighting}
\end{Shaded}

\hypertarget{logit}{%
\subsection{Logit}\label{logit}}

Run a Logistic regression analysis.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{system.time}\NormalTok{(\{}
\NormalTok{logit <-}\StringTok{ }\KeywordTok{glm}\NormalTok{(formula, }\DataTypeTok{data=}\NormalTok{ train,}
             \DataTypeTok{family=}\KeywordTok{binomial}\NormalTok{(}\DataTypeTok{link=}\StringTok{'logit'}\NormalTok{))}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    user  system elapsed 
##    1.33    0.02    1.50
\end{verbatim}

Depict the performance measures by running the following chunks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fitted.prob.logit <-}\StringTok{ }\KeywordTok{predict}\NormalTok{(logit, }\DataTypeTok{newdata=}\NormalTok{test, }\DataTypeTok{type=}\StringTok{'response'}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fitted.logit <-}\StringTok{ }\KeywordTok{as.numeric}\NormalTok{(fitted.prob.logit)}
\NormalTok{fg.logit <-}\StringTok{ }\NormalTok{fitted.logit[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{bg.logit <-}\StringTok{ }\NormalTok{fitted.logit[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{roc_logit <-}\StringTok{ }\KeywordTok{roc.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.logit,}
                       \DataTypeTok{scores.class1 =}\NormalTok{ bg.logit,}
                       \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(roc_logit)}
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-11-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pr_logit <-}\StringTok{ }\KeywordTok{pr.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.logit,}
                     \DataTypeTok{scores.class1 =}\NormalTok{ bg.logit,}
                     \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(pr_logit) }
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-12-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fitted.logit <-}\StringTok{ }\KeywordTok{ifelse}\NormalTok{(fitted.prob.logit}\OperatorTok{>}\FloatTok{0.5}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{0}\NormalTok{)}
\NormalTok{f1_logit <-}\StringTok{ }\KeywordTok{f1_score}\NormalTok{(fitted.logit,}
\NormalTok{                     test}\OperatorTok{$}\NormalTok{failure,}
                     \DataTypeTok{positive.class=}\StringTok{"1"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balanced_accuracy_logit<-}\KeywordTok{balanced_accuracy}\NormalTok{(fitted.logit, test}\OperatorTok{$}\NormalTok{failure)}
\NormalTok{accuracy_logit <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{rbind}\NormalTok{(}\KeywordTok{postResample}\NormalTok{(fitted.logit,}
\NormalTok{                                                   test}\OperatorTok{$}\NormalTok{failure)))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{logit_fit <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(roc_logit}\OperatorTok{$}\NormalTok{auc,}
\NormalTok{                                 pr_logit}\OperatorTok{$}\NormalTok{auc.integral,}
\NormalTok{                                 f1_logit,}
\NormalTok{                                 balanced_accuracy_logit,}
\NormalTok{                                 accuracy_logit}\OperatorTok{$}\NormalTok{Rsquared))}
\KeywordTok{colnames}\NormalTok{(logit_fit) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AUC"}\NormalTok{, }\StringTok{"PR"}\NormalTok{, }\StringTok{"f1-score"}\NormalTok{, }\StringTok{"BACC"}\NormalTok{, }\StringTok{"Rsquared"}\NormalTok{)}
\NormalTok{logit_fit}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         AUC        PR  f1-score      BACC   Rsquared
## 1 0.9026294 0.2901828 0.2539683 0.7144608 0.07022326
\end{verbatim}

\hypertarget{classification-tree}{%
\subsection{Classification Tree}\label{classification-tree}}

Run a classification tree analysis.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}
\KeywordTok{system.time}\NormalTok{(\{}
\NormalTok{c.tree <-}\StringTok{ }\KeywordTok{ctree}\NormalTok{(formula, }\DataTypeTok{data=}\NormalTok{train,}
               \DataTypeTok{control =} \KeywordTok{ctree_control}\NormalTok{(}\DataTypeTok{testtype =} \StringTok{"MonteCarlo"}\NormalTok{,}
               \DataTypeTok{mincriterion =} \FloatTok{0.90}\NormalTok{, }\DataTypeTok{nresample =} \DecValTok{1000}\NormalTok{))}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    user  system elapsed 
##   18.67    0.06   20.65
\end{verbatim}

Depict the performance measures by running the following chunks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fitted.results.tree <-}\StringTok{ }\KeywordTok{as.matrix}\NormalTok{(}\KeywordTok{unlist}\NormalTok{(}\KeywordTok{predict}\NormalTok{(c.tree,}
                                 \DataTypeTok{newdata =}\NormalTok{ test, }\DataTypeTok{type=}\StringTok{'prob'}\NormalTok{)))}
\NormalTok{fitted.prob.tree <-}\StringTok{ }\NormalTok{fitted.results.tree[}\KeywordTok{seq_along}\NormalTok{(fitted.results.tree) }\OperatorTok{%%}\DecValTok{2} \OperatorTok{==}\StringTok{ }\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#Roc}
\NormalTok{fg.tree<-fitted.prob.tree[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{bg.tree<-fitted.prob.tree[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{roc_ctree <-}\StringTok{ }\KeywordTok{roc.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.tree,}
                       \DataTypeTok{scores.class1 =}\NormalTok{ bg.tree,}
                       \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(roc_ctree) }
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-19-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pr_ctree <-}\StringTok{ }\KeywordTok{pr.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.tree,}
                     \DataTypeTok{scores.class1 =}\NormalTok{ bg.tree,}
                     \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(pr_ctree) }
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-20-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fitted.ctree <-}\StringTok{ }\KeywordTok{predict}\NormalTok{(c.tree,}
                        \DataTypeTok{newdata =}\NormalTok{ test,}
                        \DataTypeTok{type=}\StringTok{'response'}\NormalTok{)}
\NormalTok{f1_ctree <-}\StringTok{ }\KeywordTok{f1_score}\NormalTok{(fitted.ctree,}
\NormalTok{                     test}\OperatorTok{$}\NormalTok{failure,}
                     \DataTypeTok{positive.class=}\StringTok{"1"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balanced_accuracy_ctree <-}\StringTok{ }\KeywordTok{balanced_accuracy}\NormalTok{(fitted.ctree, test}\OperatorTok{$}\NormalTok{failure)}
\NormalTok{accuracy_ctree <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{rbind}\NormalTok{(}\KeywordTok{postResample}\NormalTok{(}\KeywordTok{as.double}\NormalTok{(fitted.ctree), test}\OperatorTok{$}\NormalTok{failure)))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ctree_fit <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(roc_ctree}\OperatorTok{$}\NormalTok{auc,}
\NormalTok{                                 pr_ctree}\OperatorTok{$}\NormalTok{auc.integral,}
\NormalTok{                                 f1_ctree,}
\NormalTok{                                 balanced_accuracy_ctree,}
\NormalTok{                                 accuracy_ctree}\OperatorTok{$}\NormalTok{Rsquared))}
\KeywordTok{colnames}\NormalTok{(ctree_fit) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AUC"}\NormalTok{, }\StringTok{"PR"}\NormalTok{, }\StringTok{"f1-score"}\NormalTok{, }\StringTok{"BACC"}\NormalTok{, }\StringTok{"Rsquared"}\NormalTok{)}
\NormalTok{ctree_fit}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         AUC       PR  f1-score      BACC   Rsquared
## 1 0.8826998 0.257509 0.1935484 0.6655942 0.03944777
\end{verbatim}

\hypertarget{random-forest}{%
\subsection{Random Forest}\label{random-forest}}

Run a Random Forest analysis.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{2020}\NormalTok{)}

\KeywordTok{system.time}\NormalTok{(\{}
\NormalTok{rf <-}\StringTok{ }\KeywordTok{randomForest}\NormalTok{(formula, }\DataTypeTok{data=}\NormalTok{train,}
                   \DataTypeTok{importance =} \OtherTok{FALSE}\NormalTok{,}
                   \DataTypeTok{ntree=}\DecValTok{200}\NormalTok{)}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##    user  system elapsed 
##    9.23    0.05   10.00
\end{verbatim}

Depict the performance measures by running the following chunks.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# Fitted results Random Forest}
\NormalTok{fitted.prob.rf <-}\StringTok{ }\KeywordTok{predict}\NormalTok{(rf, }\DataTypeTok{newdata=}\NormalTok{test, }\DataTypeTok{type=}\StringTok{'prob'}\NormalTok{) }
\NormalTok{fitted.prob.rf <-}\StringTok{ }\NormalTok{fitted.prob.rf[,}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#Roc}
\NormalTok{fg.rf<-fitted.prob.rf[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{1}\NormalTok{]}
\NormalTok{bg.rf<-fitted.prob.rf[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{roc_rf <-}\StringTok{ }\KeywordTok{roc.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.rf,}
                    \DataTypeTok{scores.class1 =}\NormalTok{ bg.rf,}
                    \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(roc_rf)}
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-27-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pr_rf<-}\KeywordTok{pr.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.rf,}
                \DataTypeTok{scores.class1 =}\NormalTok{ bg.rf,}
                \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(pr_rf)}
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-28-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fitted.rf <-}\StringTok{ }\KeywordTok{ifelse}\NormalTok{(fitted.prob.rf }\OperatorTok{>}\StringTok{ }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{f1_rf <-}\StringTok{ }\KeywordTok{f1_score}\NormalTok{(fitted.rf,}
\NormalTok{                  test}\OperatorTok{$}\NormalTok{failure,}
                  \DataTypeTok{positive.class=}\StringTok{"1"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balanced_accuracy_rf <-}\StringTok{ }\KeywordTok{balanced_accuracy}\NormalTok{(fitted.rf, test}\OperatorTok{$}\NormalTok{failure)}
\NormalTok{accuracy_rf <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{rbind}\NormalTok{(}\KeywordTok{postResample}\NormalTok{(}\KeywordTok{as.double}\NormalTok{(fitted.rf),}
\NormalTok{                                                      test}\OperatorTok{$}\NormalTok{failure)))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rf_fit <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(roc_rf}\OperatorTok{$}\NormalTok{auc,}
\NormalTok{                              pr_rf}\OperatorTok{$}\NormalTok{auc.integral,}
\NormalTok{                              f1_rf, balanced_accuracy_rf,}
\NormalTok{                              accuracy_rf}\OperatorTok{$}\NormalTok{Rsquared))}
\KeywordTok{colnames}\NormalTok{(rf_fit) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AUC"}\NormalTok{, }\StringTok{"PR"}\NormalTok{, }\StringTok{"f1-score"}\NormalTok{, }\StringTok{"BACC"}\NormalTok{, }\StringTok{"Rsquared"}\NormalTok{)}
\NormalTok{rf_fit}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##        AUC        PR  f1-score      BACC Rsquared
## 1 0.893594 0.3971705 0.2857143 0.7444208 0.091214
\end{verbatim}

\hypertarget{super-learner}{%
\subsection{Super Learner}\label{super-learner}}

Run a super learner analysis, by using an ensemble method with three
learners: a logistic regression, a classification tree and a random
forest.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{SL.library <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"SL.glm"}\NormalTok{,  }\StringTok{"SL.randomForest"}\NormalTok{, }\StringTok{"SL.rpartPrune"}\NormalTok{) }
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{train}\OperatorTok{$}\NormalTok{X <-(train[predictors])}
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}
\KeywordTok{system.time}\NormalTok{(\{}
\NormalTok{  SL <-}\StringTok{ }\KeywordTok{SuperLearner}\NormalTok{(}\DataTypeTok{Y=}\NormalTok{train}\OperatorTok{$}\NormalTok{failure, }\DataTypeTok{X=}\NormalTok{train}\OperatorTok{$}\NormalTok{X,}
                     \DataTypeTok{SL.library =}\NormalTok{ SL.library,}
                     \DataTypeTok{verbose =} \OtherTok{FALSE}\NormalTok{,}
                     \DataTypeTok{method =} \StringTok{"method.NNLS"}\NormalTok{,}
                     \DataTypeTok{family =} \KeywordTok{binomial}\NormalTok{())}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Error in model.frame.default(Terms, newdata, na.action = na.action, xlev = object$xlevels) : 
##   factor area has new levels
\end{verbatim}

\begin{verbatim}
##    user  system elapsed 
##  434.70    5.86  477.24
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{coef}\NormalTok{(SL)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          SL.glm_All SL.randomForest_All   SL.rpartPrune_All 
##          0.00000000          0.96255974          0.03744026
\end{verbatim}

Depict the performance measures by running the following chunks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test}\OperatorTok{$}\NormalTok{X <-(test[predictors])}
\NormalTok{sl.fitted <-}\StringTok{ }\KeywordTok{predict.SuperLearner}\NormalTok{(SL, test}\OperatorTok{$}\NormalTok{X,}
                                  \DataTypeTok{X =}\NormalTok{ train}\OperatorTok{$}\NormalTok{X,}
                                  \DataTypeTok{Y =}\NormalTok{ train}\OperatorTok{$}\NormalTok{failure,}
                                  \DataTypeTok{onlySL =} \OtherTok{TRUE}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#Roc}
\NormalTok{fg.sl<-sl.fitted}\OperatorTok{$}\NormalTok{pred[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{1}\NormalTok{] }
\NormalTok{bg.sl<-sl.fitted}\OperatorTok{$}\NormalTok{pred[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{roc_sl<-}\KeywordTok{roc.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.sl,}
                  \DataTypeTok{scores.class1 =}\NormalTok{ bg.sl,}
                  \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(roc_sl) }
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-36-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pr_sl<-}\KeywordTok{pr.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.sl,}
                \DataTypeTok{scores.class1 =}\NormalTok{ bg.sl,}
                \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(pr_sl)}
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-37-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fitted.sl <-}\StringTok{ }\KeywordTok{ifelse}\NormalTok{(sl.fitted}\OperatorTok{$}\NormalTok{pred }\OperatorTok{>}\StringTok{ }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{f1_sl <-}\StringTok{ }\KeywordTok{f1_score}\NormalTok{(fitted.sl,}
\NormalTok{                  test}\OperatorTok{$}\NormalTok{failure,}
                  \DataTypeTok{positive.class=}\StringTok{"1"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balanced_accuracy_sl <-}\StringTok{ }\KeywordTok{balanced_accuracy}\NormalTok{(fitted.sl, test}\OperatorTok{$}\NormalTok{failure)}
\NormalTok{accuracy_sl <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{rbind}\NormalTok{(}\KeywordTok{postResample}\NormalTok{(}\KeywordTok{as.double}\NormalTok{(fitted.sl),}
\NormalTok{                                                      test}\OperatorTok{$}\NormalTok{failure)))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sl_fit <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(roc_sl}\OperatorTok{$}\NormalTok{auc,}
\NormalTok{                              pr_sl}\OperatorTok{$}\NormalTok{auc.integral,}
\NormalTok{                              f1_sl,}
\NormalTok{                              balanced_accuracy_sl,}
\NormalTok{                              accuracy_sl}\OperatorTok{$}\NormalTok{Rsquared))}
\KeywordTok{colnames}\NormalTok{(sl_fit) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AUC"}\NormalTok{, }\StringTok{"PR"}\NormalTok{, }\StringTok{"f1-score"}\NormalTok{, }\StringTok{"BACC"}\NormalTok{, }\StringTok{"Rsquared"}\NormalTok{)}
\NormalTok{sl_fit}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##         AUC        PR  f1-score      BACC Rsquared
## 1 0.9107908 0.4137456 0.2857143 0.7444208 0.091214
\end{verbatim}

\hypertarget{bart-mia}{%
\subsection{BART-mia}\label{bart-mia}}

Run a Bayesian Additive Regression Tree analysis by using the overall
data sample (no need to omit the observations with missing values).

Select the same number of observations as in the previous models for the
training and testing samples.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{train <-}\StringTok{ }\NormalTok{omitted[index,]}
\NormalTok{test <-}\StringTok{ }\NormalTok{omitted[}\OperatorTok{-}\NormalTok{index,]}
\NormalTok{train}\OperatorTok{$}\NormalTok{X <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(train[predictors])}
\NormalTok{test}\OperatorTok{$}\NormalTok{X <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(test[predictors])}
\end{Highlighting}
\end{Shaded}

Run the analysis.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{system.time}\NormalTok{(\{}
\NormalTok{bart_machine <-}\StringTok{ }\KeywordTok{bartMachine}\NormalTok{(train}\OperatorTok{$}\NormalTok{X,}
                          \KeywordTok{as.factor}\NormalTok{(train}\OperatorTok{$}\NormalTok{failure),}
                          \DataTypeTok{use_missing_data=}\OtherTok{TRUE}\NormalTok{) }
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## bartMachine initializing with 50 trees...
## bartMachine vars checked...
## bartMachine java init...
## bartMachine factors created...
## bartMachine before preprocess...
## bartMachine after preprocess... 67 total features...
## bartMachine sigsq estimated...
## bartMachine training data finalized...
## Now building bartMachine for classification ...Covariate importance prior ON. Missing data feature ON. 
## evaluating in sample data...done
\end{verbatim}

\begin{verbatim}
##    user  system elapsed 
##   91.94    5.31   98.64
\end{verbatim}

Depict the performance measures by running the following chunks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fitted.results.bart <-}\StringTok{ }\DecValTok{1}\OperatorTok{-}\StringTok{ }\KeywordTok{round}\NormalTok{(}\KeywordTok{predict}\NormalTok{(bart_machine,}
\NormalTok{                                        test}\OperatorTok{$}\NormalTok{X,}
                                        \DataTypeTok{type=}\StringTok{'prob'}\NormalTok{), }\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#Roc}
\NormalTok{fg.bart<-fitted.results.bart[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{1}\NormalTok{] }
\NormalTok{bg.bart<-fitted.results.bart[test}\OperatorTok{$}\NormalTok{failure}\OperatorTok{==}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{roc_bart<-}\KeywordTok{roc.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.bart,}
                    \DataTypeTok{scores.class1 =}\NormalTok{ bg.bart,}
                    \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(roc_bart)}
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-45-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pr_bart<-}\KeywordTok{pr.curve}\NormalTok{(}\DataTypeTok{scores.class0 =}\NormalTok{ fg.bart,}
                  \DataTypeTok{scores.class1 =}\NormalTok{ bg.bart,}
                  \DataTypeTok{curve =}\NormalTok{ T)}
\KeywordTok{plot}\NormalTok{(pr_bart)}
\end{Highlighting}
\end{Shaded}

\includegraphics{ml_analysis_lagged_with_imputation_files/figure-latex/unnamed-chunk-46-1.pdf}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#Get Accurancy}
\NormalTok{fitted.bart <-}\StringTok{ }\KeywordTok{ifelse}\NormalTok{(fitted.results.bart}\OperatorTok{>}\StringTok{ }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{f1_bart <-}\StringTok{ }\KeywordTok{f1_score}\NormalTok{(fitted.bart,}
\NormalTok{                    test}\OperatorTok{$}\NormalTok{failure,}
                    \DataTypeTok{positive.class=}\StringTok{"1"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balanced_accuracy_bart <-}\StringTok{ }\KeywordTok{balanced_accuracy}\NormalTok{(fitted.bart, test}\OperatorTok{$}\NormalTok{failure)}
\NormalTok{accuracy_bart <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{rbind}\NormalTok{(}\KeywordTok{postResample}\NormalTok{(}\KeywordTok{as.double}\NormalTok{(fitted.bart),}
\NormalTok{                                                    test}\OperatorTok{$}\NormalTok{failure)))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bart_fit <-}\StringTok{ }\KeywordTok{as.data.frame}\NormalTok{(}\KeywordTok{cbind}\NormalTok{(roc_bart}\OperatorTok{$}\NormalTok{auc,}
\NormalTok{                                pr_bart}\OperatorTok{$}\NormalTok{auc.integral,}
\NormalTok{                                f1_bart,}
\NormalTok{                                balanced_accuracy_bart,}
\NormalTok{                                accuracy_bart}\OperatorTok{$}\NormalTok{Rsquared))}
\KeywordTok{colnames}\NormalTok{(bart_fit) <-}\StringTok{ }\KeywordTok{c}\NormalTok{(}\StringTok{"AUC"}\NormalTok{, }\StringTok{"PR"}\NormalTok{, }\StringTok{"f1-score"}\NormalTok{, }\StringTok{"BACC"}\NormalTok{, }\StringTok{"Rsquared"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\hypertarget{save-results}{%
\subsection{Save Results}\label{save-results}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model_results <-}\StringTok{ }\KeywordTok{rbind}\NormalTok{(logit_fit, ctree_fit, rf_fit, sl_fit, bart_fit)}
\CommentTok{# write.csv(model_results, file = "model_results.csv")}
\NormalTok{model_results}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
##          AUC        PR  f1-score      BACC   Rsquared
## 1  0.9026294 0.2901828 0.2539683 0.7144608 0.07022326
## 11 0.8826998 0.2575090 0.1935484 0.6655942 0.03944777
## 12 0.8935940 0.3971705 0.2857143 0.7444208 0.09121400
## 13 0.9107908 0.4137456 0.2857143 0.7444208 0.09121400
## 14 0.9612364 0.6566505 0.5205479 0.8368851 0.27219202
\end{verbatim}


\end{document}
